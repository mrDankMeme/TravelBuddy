default_platform(:ios)

platform :ios do
  desc "Run UI snapshot tests only (fast and deterministic)"
  lane :snapshots do
    repo_root    = File.expand_path("..", __dir__)                # ../
    project_path = File.join(repo_root, "TravelBuddy.xcodeproj")  # <repo>/TravelBuddy.xcodeproj

    # Прогреть SwiftPM (быстро, из кэша CI)
    sh %(
      xcodebuild -resolvePackageDependencies \
        -project "#{project_path}" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    )

    # Снимки: запускаем ТОЛЬКО наш снапшот-класс
    snapshot(
      project: project_path,
      scheme:  "TravelBuddy",

      output_directory:  "fastlane/screenshots",
      derived_data_path: "fastlane/DerivedData",

      clean:                   false,   # не чистим кэш SPM/DerivedData
      reinstall_app:           true,    # приложение каждый раз с нуля
      erase_simulator:         false,
      concurrent_simulators:   false,

      skip_package_dependencies_resolution: true,
      disable_package_automatic_updates:    true,

      result_bundle:           false,
      number_of_retries:       0,

      # ВАЖНО: запускаем только наш тест-класс,
      # чтобы не тратить время на LaunchTests/обычные UI-тесты
      only_testing: [
        "TravelBuddyUITests/TravelBuddySnapshotUITests"
      ],

      # немного помогает запуску симулятора
      prelaunch_simulator:     true,

      xcargs: "-quiet"
    )
  end
end
