default_platform(:ios)

platform :ios do
  desc "Run UI snapshot tests and export screenshots"
  lane :snapshots do
    # Абсолютный путь до .xcodeproj относительно папки fastlane
    repo_root    = File.expand_path("..", __dir__)                # ../
    project_path = File.join(repo_root, "TravelBuddy.xcodeproj")  # <repo>/TravelBuddy.xcodeproj

    # 1) Прогреть/зафиксировать SwiftPM (использует кэш в CI)
    sh %(
      xcodebuild -resolvePackageDependencies \
        -project "#{project_path}" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    )

    # 2) Снимки
    snapshot(
      project: project_path,                 # ← путь берём отсюда, НЕ из Snapfile
      scheme: "TravelBuddy",

      output_directory:      "fastlane/screenshots",
      derived_data_path:     "fastlane/DerivedData",

      # Быстро, но «с нуля» для приложения
      clean:                         false,  # DerivedData НЕ чистим (кэшируем SPM)
      reinstall_app:                 true,   # приложение на симе переустанавливаем каждый прогон
      erase_simulator:               false,
      concurrent_simulators:         false,

      # SwiftPM
      skip_package_dependencies_resolution: true,
      disable_package_automatic_updates:    true,

      # Ретраи/резалт-бандл отключены — чтобы не ловить "Existing file at -resultBundlePath"
      result_bundle:                 false,
      number_of_retries:             0,

      # Логи
      xcargs: "-quiet"
    )
  end
end
