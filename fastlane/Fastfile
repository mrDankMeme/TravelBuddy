default_platform(:ios)

platform :ios do
  desc "Run SwiftLint"
  lane :lint do
    sh "swiftlint --strict"
  end

  desc "Build Debug (simulator)"
  lane :build_debug do
    xcbuild = "xcodebuild -scheme TravelBuddy -sdk iphonesimulator -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 15' -skipPackagePluginValidation -skipMacroValidation clean build"
    sh "#{xcbuild} | xcpretty"
  end

  desc "Archive Release (device)"
  lane :archive_release do
    sh "xcodebuild -scheme TravelBuddy -configuration Release -sdk iphoneos -archivePath build/TravelBuddy.xcarchive -skipPackagePluginValidation -skipMacroValidation archive | xcpretty"
  end

  desc "Export IPA (ad-hoc)"
  lane :export_ipa do
    export_plist = "ExportOptions.plist"
    File.write(export_plist, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0"><dict>
        <key>method</key><string>ad-hoc</string>
        <key>signingStyle</key><string>automatic</string>
        <key>compileBitcode</key><false/>
        <key>destination</key><string>export</string>
        <key>stripSwiftSymbols</key><true/>
      </dict></plist>
    PLIST
    sh "xcodebuild -exportArchive -archivePath build/TravelBuddy.xcarchive -exportOptionsPlist #{export_plist} -exportPath build/export | xcpretty"
  end

  # -------- SNAPSHOT (локализация) ----------
  desc "Run UI snapshots via fastlane snapshot"
  lane :snapshots do
    clear_derived_data
    snapshot(
      scheme: "TravelBuddy",
      workspace: nil, # укажи, если используешь .xcworkspace
      devices: ["iPhone 15", "iPhone 15 Pro Max"],
      languages: ["en-US", "ru-RU"],
      stop_after_first_error: true,
      output_directory: "fastlane/screenshots",
      clean: true
    )
  end

  desc "CI lane"
  lane :ci do
    lint
    build_debug
    archive_release
    export_ipa
  ensure
    sh "mkdir -p fastlane/logs"
  end
end
