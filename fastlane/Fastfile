# fastlane/Fastfile

default_platform(:ios)

platform :ios do
  desc "Run UI snapshot tests and export screenshots"
  lane :snapshots do
    # Абсолютные пути к .xcodeproj и DerivedData, считанные от каталога fastlane/
    project_path = File.expand_path("../TravelBuddy.xcodeproj", __dir__)
    dd_path      = File.expand_path("./DerivedData", __dir__)

    # Прогреваем Swift Packages (использует кэш из CI)
    sh %(
      xcodebuild -resolvePackageDependencies \
        -project "#{project_path}" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    )

    snapshot(
      project: project_path,             # ← используем абсолютный путь
      scheme: "TravelBuddy",

      output_directory: "fastlane/screenshots",
      derived_data_path: dd_path,

      clean: false,                      # без чисток, как договорились
      reinstall_app: true,               # ставим приложение заново каждый прогон
      erase_simulator: false,
      concurrent_simulators: false,

      skip_package_dependencies_resolution: true,
      disable_package_automatic_updates: true,

      result_bundle: true,
      xcargs: "-quiet"
    )
  end
end
