# Подними таймауты парсинга build settings — это снимает «рандомные» таймауты xcodebuild.
ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "180"
ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "2"
ENV["FASTLANE_SNAPSHOT"] = "YES"

default_platform(:ios)

platform :ios do
  desc "Run UI snapshots via fastlane snapshot"
  lane :snapshots do
    project_path = "./TravelBuddy.xcodeproj"

    # Прогреть SPM один раз (с выключенным автоапдейтом)
    sh %(
      xcodebuild -resolvePackageDependencies \
        -project "#{project_path}" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    )

    # Бежим только класс снапшотов, чтобы не тратить время на другие UI-тесты
    snapshot(
      project: project_path,
      scheme:  "TravelBuddy",

      test_target_name: "TravelBuddyUITests",
      only_testing:     ["TravelBuddyUITests/TravelBuddySnapshotUITests"],

      # Путь/DerivedData/прочие — будут подтянуты из Snapfile
      # Никаких 'prelaunch_simulator' и т.п.
    )
  end
end
