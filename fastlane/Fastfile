default_platform(:ios)

platform :ios do
  desc "Run UI snapshot tests and export screenshots"
  lane :snapshots do
    # ВАЖНО:
    #  - НЕ чистим DerivedData (clean=false в Snapfile), чтобы SPM кеши оставались.
    #  - Приложение переустанавливаем каждый прогон (reinstall_app=true в Snapfile).
    #  - Параметры девайсов/локалей/флагов читаются из Snapfile.

    # Прогреваем зависимoсти (локально полезно; в CI это делается отдельным шагом).
    # Если позже появится .xcworkspace — замени -project на -workspace и добавь -scheme.
    sh %(
      xcodebuild -resolvePackageDependencies \
        -project "./TravelBuddy.xcodeproj" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    )

    snapshot(
      # Большинство настроек уже в Snapfile — здесь оставляем только то,
      # что точно хотим переопределить/зафиксировать на уровне lane.
      project: "./TravelBuddy.xcodeproj",
      scheme:  "TravelBuddy",

      output_directory:  "fastlane/screenshots",
      derived_data_path: "fastlane/DerivedData",

      # Никаких полных clean/erase — запускаем быстро и стабильно
      reinstall_app: true,
      erase_simulator: false,
      concurrent_simulators: false,

      # SPM не трогаем: пусть берётся из кеша
      skip_package_dependencies_resolution: true,
      disable_package_automatic_updates:    true,

      # Не просим .xcresult (убирает падения при ретраях, ускоряет)
      result_bundle: false,

      # Тише вывод xcodebuild (основные логи всё равно в артефактах)
      xcargs: "-quiet"
    )
  end
end
