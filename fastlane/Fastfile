default_platform(:ios)

platform :ios do
  desc "Run UI snapshots via fastlane snapshot"
  lane :snapshots do
    project_path = "./TravelBuddy.xcodeproj"

    # 1️⃣ Прогрев SPM (локально, чтобы CI не тайм-аутился)
    sh <<~CMD
      xcodebuild -resolvePackageDependencies \
        -project "#{project_path}" \
        -onlyUsePackageVersionsFromResolvedFile \
        -disableAutomaticPackageResolution
    CMD

    # 2️⃣ Основной запуск snapshot
    snapshot(
      project: project_path,
      scheme: "TravelBuddy",
      test_target_name: "TravelBuddyUITests",     # ⚠️ Если тесты лежат в этом таргете
      only_testing: ["TravelBuddyUITests/TravelBuddySnapshotUITests"],
      devices: ["iPhone 16 Pro"],
      languages: ["en-US"],
      output_directory: "fastlane/screenshots",
      derived_data_path: "fastlane/DerivedData",
      reinstall_app: true,
      erase_simulator: false,
      headless: true,
      override_status_bar: true,
      skip_package_dependencies_resolution: true,
      disable_package_automatic_updates: true,
      result_bundle: false,
      number_of_retries: 0,
      xcodebuild_formatter: "xcbeautify"
    )
  end
end
